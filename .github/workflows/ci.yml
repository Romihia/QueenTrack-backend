name: CI/CD Pipeline

on:
  push:
    branches:
      - stage
      - main

jobs:
  # Job ×œ×‘×“×™×§×•×ª ×•-Docker
  validate-and-docker:
    runs-on: ubuntu-latest

    steps:
      # Checkout ×©×œ ×”×§×•×“
      - name: Checkout code
        uses: actions/checkout@v3

      # ×›××©×¨ ×‘×•×“×§×™× ××ª branch 'stage', × ×‘×¦×¢ ×‘×“×™×§×•×ª
      - name: Install dependencies and run tests
        if: github.ref_name == 'stage'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pytest

      # ×‘×•×“×§×™× ×©×”-Docker Image × ×‘× ×” ×•×¢×•×‘×“
      - name: Build Docker Image
        run: docker build -t queentrack-backend:latest .

      - name: Run Docker Container (Test)
        run: |
          docker run --name queentrack-backend-test -d -p 8000:8000 queentrack-backend:latest
          sleep 10  # ×××ª×™× ×™× ×œ×•×•×“× ×©×”×©×™×¨×•×ª ×¢×œ×”
          docker ps  # ××¦×™×’×™× ×§×•× ×˜×™×™× ×¨×™× ×¤×¢×™×œ×™×

      # ×‘×“×™×§×ª ×‘×¨×™××•×ª ×”×§×•× ×˜×™×™× ×¨
      - name: Health Check
        run: |
          # ×‘×“×™×§×” ×× ×”×©×™×¨×•×ª ××’×™×‘
          curl -f http://localhost:8000/health || curl -f http://localhost:8000/ || echo "Service may not have health endpoint, continuing..."

      # ×¢×¦×™×¨×ª ×”×§×•× ×˜×™×™× ×¨
      - name: Stop Docker Container
        run: docker stop queentrack-backend-test && docker rm queentrack-backend-test

  # Job ××•×˜×•××˜×™ ×œ×¤×¨×™×¡×” ×œ×¤×¨×•×“×§×©×Ÿ
  deploy-to-production:
    if: github.ref_name == 'main'
    needs: validate-and-docker
    runs-on: ubuntu-latest

    environment:
      name: production
      url: http://${{ secrets.PRODUCTION_HOST }}:8000

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ×”×›× ×ª ××¤×ª×— SSH
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      # ×”×¢×‘×¨×ª ×§×‘×¦×™ ×”×¤×¨×™×¡×” ×œ×©×¨×ª
      - name: Copy deployment files to server
        run: |
          # Copy docker-compose production file
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/opt/queentrack/

          # Copy production environment file
          scp -i ~/.ssh/id_rsa .env.production ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/opt/queentrack/

          # Copy deployment script
          scp -i ~/.ssh/id_rsa .github/scripts/deploy.sh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/opt/queentrack/

          # Make deployment script executable
          ssh -i ~/.ssh/id_rsa ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "chmod +x /opt/queentrack/deploy.sh"

      # ×‘×™×¦×•×¢ ×¤×¨×™×¡×” ××•×˜×•××˜×™×ª
      - name: Deploy to Production Server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            set -e
            echo "ğŸš€ Starting QueenTrack deployment process..."
            
            # Navigate to project directory
            cd /opt/queentrack
            
            # Update repository URL in deploy script with actual repo
            sed -i 's|YOUR_USERNAME|${{ github.repository_owner }}|g' deploy.sh
            
            # Pull latest code from main branch
            echo "ğŸ“¥ Pulling latest code from main branch..."
            git fetch origin || git clone https://github.com/${{ github.repository }}.git .
            git checkout main
            git reset --hard origin/main
            
            # Setup production environment
            echo "âš™ï¸ Setting up production environment..."
            if [ -f ".env.production" ]; then
                cp .env.production .env
                echo "âœ… Production environment configured"
            fi
            
            # Stop existing containers
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            # Clean up old Docker images
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -af || true
            
            # Build and start new containers
            echo "ğŸ”¨ Building and starting new containers..."
            docker-compose -f docker-compose.prod.yml up --build -d
            
            # Wait for services to start
            echo "â³ Waiting for services to start..."
            sleep 20
            
            # Health check
            echo "ğŸ¥ Checking service health..."
            if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "âœ… Deployment successful! Service is running."
              docker-compose -f docker-compose.prod.yml ps
            else
              echo "âŒ Deployment failed! Service is not running."
              docker-compose -f docker-compose.prod.yml logs
              exit 1
            fi
            
            echo "ğŸ‰ Deployment completed successfully!"
          EOF

      # ×‘×“×™×§×ª ×‘×¨×™××•×ª ××¨×—×•×§
      - name: Final Health Check
        run: |
          echo "ğŸ” Performing final health check..."
          sleep 10
          # ×‘×“×™×§×” ×× ×”×©×™×¨×•×ª ××’×™×‘ ××”××™× ×˜×¨× ×˜
          curl -f http://${{ secrets.PRODUCTION_HOST }}:8000/health || curl -f http://${{ secrets.PRODUCTION_HOST }}:8000/ || echo "âš ï¸ Service may not have health endpoint, but deployment completed."

      # ×”×ª×¨××” ×¢×œ ×”×¦×œ×—×”
      - name: Deployment Success Notification
        run: |
          echo "ğŸ‰ SUCCESS: QueenTrack Backend deployed to production!"
          echo "ğŸŒ Production URL: http://${{ secrets.PRODUCTION_HOST }}:8000"
          echo "ğŸ“Š Monitor service: docker-compose -f docker-compose.prod.yml ps"
          echo "ğŸ“‹ View logs: docker-compose -f docker-compose.prod.yml logs"

      - name: Create deployment package
        run: |
          # Create deployment files
          mkdir -p deploy
          cp docker-compose.prod.yml deploy/

          # Create secure environment file
          cat > deploy/.env.production << EOF
          $(cat .env.production)
          SERVER_PASSWORD=${{ secrets.SERVER_PASSWORD }}
          EOF

          # Copy deployment script
          cp .github/scripts/deploy.sh deploy/
          chmod +x deploy/deploy.sh
