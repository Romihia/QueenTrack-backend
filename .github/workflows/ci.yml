name: CI/CD Pipeline

on:
  push:
    branches:
      - stage
      - main

jobs:
  # Job ×œ×‘×“×™×§×•×ª ×•-Docker
  validate-and-docker:
    runs-on: ubuntu-latest

    steps:
      # Checkout ×©×œ ×”×§×•×“
      - name: Checkout code
        uses: actions/checkout@v3

      # ×›××©×¨ ×‘×•×“×§×™× ××ª branch 'stage', × ×‘×¦×¢ ×‘×“×™×§×•×ª
      - name: Install dependencies and run tests
        if: github.ref_name == 'stage'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pytest

      # ×‘×•×“×§×™× ×©×”-Docker Image × ×‘× ×” ×•×¢×•×‘×“
      - name: Build Docker Image
        run: docker build -t bee-vision-backend:latest .

      - name: Run Docker Container (Test)
        run: |
          docker run --name bee-vision-backend-test -d -p 8000:8000 bee-vision-backend:latest
          sleep 10  # ×××ª×™× ×™× ×œ×•×•×“× ×©×”×©×™×¨×•×ª ×¢×œ×”
          docker ps  # ××¦×™×’×™× ×§×•× ×˜×™×™× ×¨×™× ×¤×¢×™×œ×™×

      # ×‘×“×™×§×ª ×‘×¨×™××•×ª ×”×§×•× ×˜×™×™× ×¨
      - name: Health Check
        run: |
          # ×‘×“×™×§×” ×× ×”×©×™×¨×•×ª ××’×™×‘
          curl -f http://localhost:8000/health || curl -f http://localhost:8000/ || echo "Service may not have health endpoint, continuing..."

      # ×¢×¦×™×¨×ª ×”×§×•× ×˜×™×™× ×¨
      - name: Stop Docker Container
        run: docker stop bee-vision-backend-test && docker rm bee-vision-backend-test

  # Job ××•×˜×•××˜×™ ×œ×¤×¨×™×¡×” ×œ×¤×¨×•×“×§×©×Ÿ
  deploy-to-production:
    if: github.ref_name == 'main'
    needs: validate-and-docker
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: http://162.55.53.52:8000

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ×”×›× ×ª ××¤×ª×— SSH
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      # ×”×¢×‘×¨×ª ×§×‘×¦×™ ×”×¤×¨×™×¡×” ×œ×©×¨×ª
      - name: Copy deployment files
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.yml ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/opt/queentrack/
          scp -i ~/.ssh/id_rsa -r .github/scripts/deploy.sh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/opt/queentrack/

      # ×‘×™×¦×•×¢ ×¤×¨×™×¡×” ××•×˜×•××˜×™×ª
      - name: Deploy to Production Server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            set -e
            echo "ğŸš€ Starting deployment process..."
            
            # ××¢×‘×¨ ×œ×ª×™×§×™×™×ª ×”×¤×¨×•×™×§×˜
            cd /opt/queentrack
            
            # ×¢×“×›×•×Ÿ ×”×§×•×“ ×-Git
            echo "ğŸ“¥ Pulling latest code from main branch..."
            git fetch origin
            git reset --hard origin/main
            
            # ×‘×“×™×§×” ×× ×™×© ×§×•× ×˜×™×™× ×¨×™× ×¤×¢×™×œ×™×
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose down || true
            
            # ××—×™×§×ª ×ª××•× ×•×ª Docker ×™×©× ×•×ª (×œ×—×™×¡×›×•×Ÿ ×‘××§×•×)
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -af || true
            
            # ×‘× ×™×™×ª ×ª××•× ×ª Docker ×—×“×©×”
            echo "ğŸ”¨ Building new Docker image..."
            docker-compose build --no-cache
            
            # ×”×¨×¦×ª ×”×§×•× ×˜×™×™× ×¨×™× ×”×—×“×©×™×
            echo "ğŸš€ Starting new containers..."
            docker-compose up -d
            
            # ×‘×“×™×§×ª ×‘×¨×™××•×ª ×”×©×™×¨×•×ª
            echo "ğŸ¥ Checking service health..."
            sleep 15
            
            # ×‘×“×™×§×” ×©×”×§×•× ×˜×™×™× ×¨ ×¤×•×¢×œ
            if docker-compose ps | grep -q "Up"; then
              echo "âœ… Deployment successful! Service is running."
              docker-compose ps
            else
              echo "âŒ Deployment failed! Service is not running."
              docker-compose logs
              exit 1
            fi
            
            echo "ğŸ‰ Deployment completed successfully!"
          EOF

      # ×‘×“×™×§×ª ×‘×¨×™××•×ª ××¨×—×•×§
      - name: Final Health Check
        run: |
          echo "ğŸ” Performing final health check..."
          sleep 10
          # ×‘×“×™×§×” ×× ×”×©×™×¨×•×ª ××’×™×‘ ××”××™× ×˜×¨× ×˜
          curl -f http://${{ secrets.PRODUCTION_HOST }}:8000/health || curl -f http://${{ secrets.PRODUCTION_HOST }}:8000/ || echo "âš ï¸ Service may not have health endpoint, but deployment completed."

      # ×”×ª×¨××” ×¢×œ ×”×¦×œ×—×”
      - name: Deployment Success Notification
        run: |
          echo "ğŸ‰ SUCCESS: Application deployed to production!"
          echo "ğŸŒ Production URL: http://${{ secrets.PRODUCTION_HOST }}:8000"
          echo "ğŸ“Š You can check the service status with: docker-compose ps"
